# updates
## 260108 haieki_killing3_1.pyを公開しました
- CAS番と日本語名の入力をファイルに保存しするように改修しました。
- data ディレクトリの中にAPIアクセス用秘密鍵ファイルとともに格納しています(ラボメンバー外非公開)。
## 260107 main3.pyを公開しました
- CAS番と日本語名の入力回数を減らすため, 各セッションで一度入力した物質のCAS番号, または日本語名を記憶しています
- ファイルに保存して未来永劫入力しなくてよくするかは未定ですが, めんどくさくなったらやります

# 廃液しばきスクリプト, HSS
　廃液集計が面倒すぎてキレそうなので自動化しました。高橋研636, 648実験室の廃液タンクにあるQRコードからアクセスできるフォームがあります。その回答スプレッドシートをPCにDLしてスクリプトがあるディレクトリに移動し, 読み込んでなんやかんやします。
 ラボペディアからexeファイルを入手できますが, Macでは動きません。**MacはPCではないので。**

# 人間様がやること
- 廃液を出した人...フォームに入力する。正しく, 直ちに, 遅滞なく。
- 廃液係...スクリプトの指示に合わせて日本語名, 数値, CAS番などなどを入れながらスクリプトを回す。できたcsvを適宜修正し, UTCIMSに食わせる。液性は自分で測ってね♡
- hyousoicpのgoogleアカウントにログインしておくこと(ログインしなくても回るような改修はしてもいいけど希望があったらかな)

# 大まかな構成
v3.1の処理の流れ
## 0. 廃液管理(回答)をダウンロードしてきて作業ディレクトリに移動→ファイルと変数のリネーム
## 1. 行削除関数の作成
### 1.0. 認証情報, サービスアカウント, 秘密鍵, クライアントの作成, データ読み込み
### 1.1. データを上から見ていき, 捨てた廃液タンクIDが見つかればそれを削除→データ再読み込み
### 1.2. ID見つからなくなったら=全投入イベントの記録を削除したらbreak
## 2. 過去の入力内容読み出し
### 2.0. ファイルに保存してある過去のCAS番-物質名とascii名(英名・略称などの非日本語名)－日本語名の内容をリストに格納
### 2.1. ファイルを追記モードでひらいておく スクリプトの最後に閉じる メモリ使用量を考えるなら必要な時にだけ開けばいい(優先度低)
## 3. 投入イベントの解析・処理
## 3.0. 処理する廃液タンクIDを入力, 最後の投入イベント削除用に同時にリストに格納
df_ans: リスト, 生の回答エクセルをそのままpandasで読む
### 3.1. event: リスト, 目的のタンクIDが入力されている行番号をすべて含む
sub_list: subを含むリスト(入れ子の外側, この時点では空) の2つのリストを作成
### 3.2. 各投入イベントに対して最大4つのsubを自動で作成し, sub_listへ格納
sub...[物質名(入力ママ), 記録方法(gram, pct, ppm, mol), 重量または濃度, 体積, CAS番]
モル濃度の場合, 入力歴があればそこからCAS番を格納, なければinputで訊き出してリストに格納するとともにファイルへ追記 正規表現によるチェックあり
### 3.3. 投入イベントに5つ目以上の溶質が登録され, フォーム最後(セクション13)の長文回答に入力がなされていた場合
手入力でsubを作成 これは廃液係の仕事
#### 3.3.1. 回答を表示してひとつずつsubを作成
物質名入力がasciiだったらやり直し(日本語名のみを受付, 未実装だが警告つけた方がいいか?), ただしEnter入力は通す(入力すべきものがなくなったと判断)
#### 3.3.2. 記録方法を自動と同じように入力 w, c, p, m 以外はやり直し, 未実装だが警告つけた方がいいか?
記録方法に応じて重量・濃度と溶液の体積をsubへ格納し, できたsubをsub_listへ格納 "m" の場合は後述
#### 3.3.3. 記録方法 "m" だった場合=mol濃度
CAS番を手入力させてsubに格納 正規表現によるチェックあり, ファイルへの追記なし(入力歴探索と新規追記コードを持ってきてもいいかも)
こうしてできたsub_listをデータとしてpd.Dataframe df_disp を作成
[物質, 記録方法, 濃度または重量, 体積, CAS番]
## 4. df_disp(旧sub_list)のstring入力をfloatに変換しつつ, 親切で入力された単位・補助単位の記号を取って数値のみに成形
mg/ugなどを先に見つけて置換しておかないとgの削除に巻き込まれる 詳細はコード
   これを cong_gram と vol の両方でやる concの場合のみ数値の認識エラーの例外処理をさせる エラー文もっと頑張るべき
5. UTCIMSに食べさせるためのcsvファイルを作成
   df_dispのすべての行に対して以下の操作を実施
 5.1. 物質名がasciiであった場合, 入力履歴を探索して日本語名JPnameをみつけてくるか, 入力させて履歴ファイルに追記する JPnameでascii名を更新
 5.2. 各df_dispの行について, 記録方法ごとに出力ファイルに追加
  5.2.1. モル濃度の場合pubchempyによりCAS番号から分子量を検索 ダメだった場合は分子量を手入力
  5.2.2. 重量・重量濃度の場合そのままか掛け算して重量を出して出力ファイルに追加, 出力ファイルはいったん閉じる
6. タンクの種別と既に入っているものの重量から水の量を計算して追記, 出力ファイル完成
7. 処理済の投入イベントを削除
### 投入イベント自動削除に必要な秘密鍵ファイルはインストーラーに入れました
